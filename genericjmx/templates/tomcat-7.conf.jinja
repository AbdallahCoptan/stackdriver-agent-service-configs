{% import 'jvm-sun-hotspot-macros.jinja' as jvm -%}
# This is the monitoring configuration for Apache Tomcat 7.x and earlier.
# Make sure to enable JMX in your Tomcat configuration.
# Look for TOMCAT_HOST and TOMCAT_PORT to adjust your configuration file.
LoadPlugin java
<Plugin "java">
    JVMARG "-Djava.class.path=/opt/stackdriver/collectd/share/collectd/java/collectd-api.jar:/opt/stackdriver/collectd/share/collectd/java/generic-jmx.jar"
    LoadPlugin "org.collectd.java.GenericJMX"

    <Plugin "GenericJMX">
        <MBean "tomcat_connectors">
            ObjectName "Catalina:type=ThreadPool,name=*"
            InstanceFrom "name"
            <Value>
                Type "gauge"
                InstancePrefix "connectors-current_threads"
                Table false
                Attribute "currentThreadCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "connectors-busy_threads"
                Table false
                Attribute "currentThreadsBusy"
            </Value>
        </MBean>

        <MBean "tomcat_manager">
            ObjectName "Catalina:type=Manager,context=*,host=*"
            InstanceFrom "context"
            <Value>
                Type "gauge"
                InstancePrefix "manager-active_sessions"
                Table false
                Attribute "activeSessions"
            </Value>
        </MBean>

        <MBean "tomcat_requestProcessor">
            ObjectName "Catalina:type=GlobalRequestProcessor,name=*"
            InstanceFrom "name"
            <Value>
                Type "counter"
                InstancePrefix "request_processor-bytes_received"
                Table false
                Attribute "bytesReceived"
            </Value>
            <Value>
                Type "counter"
                InstancePrefix "request_processor-bytes_sent"
                Table false
                Attribute "bytesSent"
            </Value>
            <Value>
                Type "absolute"
                InstancePrefix "request_processor-error_count"
                Table false
                Attribute "errorCount"
            </Value>
            <Value>
                Type "counter"
                InstancePrefix "request_processor-processing_time"
                Table false
                Attribute "processingTime"
            </Value>
            <Value>
                Type "absolute"
                InstancePrefix "request_processor-request_count"
                Table false
                Attribute "requestCount"
            </Value>
        </MBean>


        <Connection>
            # When using non-standard Tomcat configurations, replace the below with
            #ServiceURL "service:jmx:rmi:///jndi/rmi://TOMCAT_HOST:TOMCAT_PORT/jmxrmi"
            ServiceURL "service:jmx:rmi:///jndi/rmi://localhost:9012/jmxrmi"
            InstancePrefix "tomcat"

            Collect "tomcat_connectors"
            Collect "tomcat_manager"
            Collect "tomcat_requestProcessor"
        </Connection>

        {{ jvm.metrics(jmx_port=9012, jmx_port_alt_name='TOMCAT_PORT', jmx_host_alt_name='TOMCAT_HOST', service='Tomcat') }}
    </Plugin>
</Plugin>

LoadPlugin match_regex
LoadPlugin target_set
LoadPlugin target_replace
<Chain "GenericJMX_tomcat">
    <Rule "rewrite_genericjmx_to_tomcat">
        <Match regex>
            Plugin "^GenericJMX$"
            PluginInstance "^tomcat.*$"
        </Match>
        <Target "replace">
            PluginInstance "tomcat" ""
        </Target>
        <Target "set">
            Plugin "tomcat"
        </Target>
        Target "return"
    </Rule>
</Chain>

<Chain "PreCache">
    <Rule "jump_to_GenericJMX_tomcat">
        <Target "jump">
            Chain "GenericJMX_tomcat"
        </Target>
    </Rule>
</Chain>
PreCacheChain "PreCache"

{{ jvm.chains() }}
