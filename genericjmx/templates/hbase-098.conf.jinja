{% import 'jvm-sun-hotspot-macros.jinja' as jvm -%}
{% block header_comment -%}
# This is the monitoring configuration for HBase 0.9.8 and later running in distributed mode.
# Look for HBASE_HOST, HBASE_MASTER_PORT, and HBASE_REGIONSERVER_PORT to adjust your configuration file.
{%- endblock %}
LoadPlugin java
<Plugin "java">
    JVMARG "-Djava.class.path=/opt/stackdriver/collectd/share/collectd/java/collectd-api.jar:/opt/stackdriver/collectd/share/collectd/java/generic-jmx.jar"
    LoadPlugin "org.collectd.java.GenericJMX"

    <Plugin "GenericJMX">
        <MBean "hbase_master_Server">
            ObjectName "Hadoop:service=HBase,name=Master,sub=Server"
            <Value>
                Type "gauge"
                InstancePrefix "master-averageLoad"
                Table false
                Attribute "averageLoad"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "master-numRegionServers"
                Table false
                Attribute "numRegionServers"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "master-numDeadRegionServers"
                Table false
                Attribute "numDeadRegionServers"
            </Value>
        </MBean>

        <MBean "hbase_ipc_IPC">
            ObjectName "Hadoop:service=HBase,name=IPC,sub=IPC"
            <Value>
                Type "gauge"
                InstancePrefix "ipc-sentBytes"
                Table false
                Attribute "sentBytes"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "ipc-receivedBytes"
                Table false
                Attribute "receivedBytes"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "ipc-queueSize"
                Table false
                Attribute "queueSize"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "ipc-numOpenConnections"
                Table false
                Attribute "numOpenConnections"
            </Value>
        </MBean>

        <MBean "hbase_regionserver_RegionServerStatistics">
            ObjectName "Hadoop:service=HBase,name=RegionServer,sub=Server"
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheCount"
                Table false
                Attribute "blockCacheCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheEvictedCount"
                Table false
                Attribute "blockCacheEvictedCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheFreeSize"
                Table false
                Attribute "blockCacheFreeSize"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheHitCount"
                Table false
                Attribute "blockCacheHitCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheHitPercent"
                Table false
                Attribute "blockCacheHitPercent"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheMissCount"
                Table false
                Attribute "blockCacheMissCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheSize"
                Table false
                Attribute "blockCacheSize"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-compactionQueueLength"
                Table false
                Attribute "compactionQueueLength"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-flushQueueLength"
                Table false
                Attribute "flushQueueLength"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-memStoreSize"
                Table false
                Attribute "memStoreSize"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-storeCount"
                Table false
                Attribute "storeCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-readRequestCount"
                Table false
                Attribute "readRequestCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-storeFileIndexSize"
                Table false
                Attribute "storeFileIndexSize"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-writeRequestCount"
                Table false
                Attribute "writeRequestCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-totalRequestCount"
                Table false
                Attribute "totalRequestCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-slowAppendCount"
                Table false
                Attribute "slowAppendCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-slowPutCount"
                Table false
                Attribute "slowPutCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-slowGetCount"
                Table false
                Attribute "slowGetCount"
            </Value>
        </MBean>


        <Connection>
            {% block master_service_url -%}
            # When using non-standard HBase configurations, replace the below with
            #ServiceURL "service:jmx:rmi:///jndi/rmi://HBASE_HOST:HBASE_MASTER_PORT/jmxrmi"
            ServiceURL "service:jmx:rmi:///jndi/rmi://localhost:10101/jmxrmi"
            {%- endblock %}
            InstancePrefix "hbasemaster"

            Collect "hbase_master_Server"
            Collect "hbase_ipc_IPC"
        </Connection>

        <Connection>
            {% block regionserver_service_url -%}
            # When using non-standard HBase configurations, replace the below with
            #ServiceURL "service:jmx:rmi:///jndi/rmi://HBASE_HOST:HBASE_REGIONSERVER_PORT/jmxrmi"
            ServiceURL "service:jmx:rmi:///jndi/rmi://localhost:10102/jmxrmi"
            {%- endblock %}
            InstancePrefix "hbaseregionserver"

            Collect "hbase_regionserver_RegionServerStatistics"
        </Connection>

        {# TODO: find a way to collect JVM metrics from both master and regionserver #}
        {% block jvm_metrics -%}
        {{ jvm.metrics(jmx_port=10102, jmx_port_alt_name='HBASE_REGIONSERVER_PORT', jmx_host_alt_name='HBASE_HOST', service='HBase') }}
        {%- endblock %}
    </Plugin>
</Plugin>

LoadPlugin match_regex
LoadPlugin target_set
LoadPlugin target_replace
<Chain "GenericJMX_hbase">
    <Rule "rewrite_genericjmx_to_hbase">
        <Match regex>
            Plugin "^GenericJMX$"
            PluginInstance "^hbase.*$"
        </Match>
        <Target "replace">
            PluginInstance "hbase" ""
        </Target>
        <Target "set">
            Plugin "hbase"
        </Target>
        Target "return"
    </Rule>
</Chain>

<Chain "PreCache">
    <Rule "jump_to_GenericJMX_hbase">
        <Target "jump">
            Chain "GenericJMX_hbase"
        </Target>
    </Rule>
</Chain>
PreCacheChain "PreCache"

{{ jvm.chains() }}
