{% import 'jvm-sun-hotspot-macros.jinja' as jvm -%}
# Look for HBASE_HOST and HBASE_REGIONSERVER_PORT to adjust your configuration file.
LoadPlugin java
<Plugin "java">
    JVMARG "-Djava.class.path=/opt/stackdriver/collectd/share/collectd/java/collectd-api.jar:/opt/stackdriver/collectd/share/collectd/java/generic-jmx.jar"
    LoadPlugin "org.collectd.java.GenericJMX"

    <Plugin "GenericJMX">
        <MBean "hbase_regionserver_RegionServerStatistics">
            ObjectName "hadoop:service=RegionServer,name=RegionServerStatistics"
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheExpressCachingRatio"
                Table false
                Attribute "blockCacheExpressCachingRatio"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheHitCachingRatio"
                Table false
                Attribute "blockCacheHitCachingRatio"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-callQueueLength"
                Table false
                Attribute "callQueueLength"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-compactionQueueLength"
                Table false
                Attribute "compactionQueueLength"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-compactionQueueSize"
                Table false
                Attribute "compactionQueueSize"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-flushQueueSize"
                Table false
                Attribute "flushQueueSize"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-hdfsBlocksLocalityIndex"
                Table false
                Attribute "hdfsBlocksLocalityIndex"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-memstoreSizeMB"
                Table false
                Attribute "memstoreSizeMB"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-numberOfOnlineRegions"
                Table false
                Attribute "numberOfOnlineRegions"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-readRequestsCount"
                Table false
                Attribute "readRequestsCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-slowHLogAppendCount"
                Table false
                Attribute "slowHLogAppendCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-usedHeapMB"
                Table false
                Attribute "usedHeapMB"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-writeRequestsCount"
                Table false
                Attribute "writeRequestsCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheCount"
                Table false
                Attribute "blockCacheCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheEvictedCount"
                Table false
                Attribute "blockCacheEvictedCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheFreeMB"
                Table false
                Attribute "blockCacheFreeMB"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheHitCount"
                Table false
                Attribute "blockCacheHitCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheMissCount"
                Table false
                Attribute "blockCacheMissCount"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-blockCacheSizeMB"
                Table false
                Attribute "blockCacheSizeMB"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-fsPreadLatencyNumOps"
                Table false
                Attribute "fsPreadLatencyNumOps"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-fsReadLatencyNumOps"
                Table false
                Attribute "fsReadLatencyNumOps"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-fsWriteLatencyNumOps"
                Table false
                Attribute "fsWriteLatencyNumOps"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-NumberOfStores"
                Table false
                Attribute "NumberOfStores"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-NumberOfStorefiles"
                Table false
                Attribute "NumberOfStorefiles"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-requestsPerSecond"
                Table false
                Attribute "requestsPerSecond"
            </Value>
            <Value>
                Type "gauge"
                InstancePrefix "regionserver-storeFileIndexSizeMB"
                Table false
                Attribute "storeFileIndexSizeMB"
            </Value>
        </MBean>


        <Connection>
            # When using non-standard HBase configurations, replace the below with
            #ServiceURL "service:jmx:rmi:///jndi/rmi://HBASE_HOST:HBASE_REGIONSERVER_PORT/jmxrmi"
            ServiceURL "service:jmx:rmi:///jndi/rmi://localhost:10102/jmxrmi"
            InstancePrefix "hbaseregionserver"

            Collect "hbase_regionserver_RegionServerStatistics"
        </Connection>

        {{ jvm.metrics(jmx_port=10102, jmx_port_alt_name='HBASE_REGIONSERVER_PORT', jmx_host_alt_name='HBASE_HOST', service='HBase') }}
    </Plugin>
</Plugin>

LoadPlugin match_regex
LoadPlugin target_set
LoadPlugin target_replace
<Chain "GenericJMX_hbase">
    <Rule "rewrite_genericjmx_to_hbase">
        <Match regex>
            Plugin "^GenericJMX$"
            PluginInstance "^hbase.*$"
        </Match>
        <Target "replace">
            PluginInstance "hbase" ""
        </Target>
        <Target "set">
            Plugin "hbase"
        </Target>
        Target "return"
    </Rule>
</Chain>

<Chain "PreCache">
    <Rule "jump_to_GenericJMX_hbase">
        <Target "jump">
            Chain "GenericJMX_hbase"
        </Target>
    </Rule>
</Chain>
PreCacheChain "PreCache"

{{ jvm.chains() }}
